# Doorbell MQTT UniFi

A small C prototype that connects a UniFi G4 Doorbell project to MQTT. It is
currently focused on reliable MQTT connectivity and message echoing while the
doorbell SFTP workflow is sketched out for future work.

## Current Capabilities

- Loads broker connection details from environment variables
- Connects to MQTT via the Eclipse Paho C client and publishes an `online`
  retained status
- Subscribes to `doorbell/set` (or a custom topic) and prints every payload
- Echoes each inbound payload to a status topic so you can verify end-to-end
  messaging
- Shuts down cleanly on `SIGINT` or `SIGTERM` and publishes `offline`

## Repository Layout

```
├── src/                 # C sources (main loop and MQTT integration)
│   ├── main.c
│   └── mqtt.c
├── include/             # Public headers shared across the program
│   └── mqtt.h
├── assests/             # Placeholder for doorbell audio/animation content
├── bin/                 # Built binary (created by make)
├── build/               # Object files and dependency data (created by make)
├── config.json          # Reserved for future JSON-driven configuration
├── Makefile             # GCC build with pkg-config integration
└── Dockerfile           # Placeholder for a future container image
```

> Note: `assests/` is intentionally checked in as a placeholder. The directory
> will eventually hold audio and animation bundles for the doorbell.

## Prerequisites

- GCC or Clang
- pkg-config
- `libpaho-mqtt3c` (Paho C client headers and library)
- Optional: `cJSON` and `libssh2` headers/libs — they are not used yet but the
  Makefile is ready for future modules

On Debian/Ubuntu you can start with:

```bash
sudo apt install build-essential pkg-config libpaho-mqtt-dev libssl-dev
```

## Build and Run

```bash
make          # release-style build in bin/doorbell-mqtt-unifi
make debug    # debug build with -O0 -g3
make run      # convenience target; requires a prior build
```

You can also run the binary manually:

```bash
./bin/doorbell-mqtt-unifi
```

When the process starts it connects to the configured broker, subscribes to
the set topic, and publishes an online heartbeat message.

## Configuration

All runtime settings are provided via environment variables. Defaults match a
local, non-TLS broker.

| Variable             | Default                | Purpose |
| -------------------- | ---------------------- | ------- |
| `MQTT_HOST`          | `localhost`            | Broker host/IP |
| `MQTT_PORT`          | `1883`                 | Broker port |
| `MQTT_SSL`           | `0`                    | Set to `1`/`true` to enable TLS |
| `MQTT_CLIENT_ID`     | `doorbell-client-<pid>`| Override the autogenerated client id |
| `MQTT_USERNAME`      | *(empty)*              | Optional username |
| `MQTT_PASSWORD`      | *(empty)*              | Optional password |
| `MQTT_QOS`           | `1`                    | QoS for subscribe/publish |
| `MQTT_KEEPALIVE`     | `30`                   | Keepalive interval in seconds |
| `MQTT_CLEAN_SESSION` | `1`                    | Set to `0` to keep subscriptions |
| `MQTT_RETAINED_ONLINE` | `1`                 | Retain online/offline status messages |
| `MQTT_CAFILE`        | *(empty)*              | Path to CA bundle (required when TLS is on) |
| `MQTT_CERTFILE`      | *(empty)*              | Client certificate (optional) |
| `MQTT_KEYFILE`       | *(empty)*              | Client key (optional) |
| `MQTT_KEYPASS`       | *(empty)*              | Password for the client key |
| `MQTT_TOPIC_SET`     | `doorbell/set`         | Topic that the service subscribes to |
| `MQTT_TOPIC_STATUS`  | `doorbell/status`      | Topic used for status updates |

Example shell session:

```bash
export MQTT_HOST=192.168.1.10
export MQTT_TOPIC_SET=homeassistant/doorbell/set
export MQTT_TOPIC_STATUS=homeassistant/doorbell/status
make run
```

If TLS is enabled (`MQTT_SSL=1`), set `MQTT_CAFILE` (and optionally
`MQTT_CERTFILE`, `MQTT_KEYFILE`, `MQTT_KEYPASS`) to point at the appropriate
certificate material.

## MQTT Flow

1. On start, the service publishes `{"status":"online"}` and subscribes to the
   configured set topic.
2. Every received MQTT payload is printed to stdout.
3. The payload is echoed back to the status topic inside
   `{"status":"echo","topic":"...","message":"..."}` so you can validate the
   round trip.
4. When the process exits it publishes `{"status":"offline"}`.

This echo loop is the foundation for the next milestones: parsing JSON,
matching incoming payloads to audio/animation bundles, and uploading them to
the doorbell via SFTP.

## Next Steps

- Parse inbound JSON (cJSON) and branch on holiday/custom payload types
- Map payloads to files stored under `assests/`
- Upload files over SFTP (libssh2) to the UniFi Protect controller
- Flesh out the Dockerfile so the service can run containerized alongside
  MQTT/Home Assistant

## Contributing

Pull requests and issue reports are welcome. Please describe the change,
mention the environment you tested in, and keep commits focused.

## License

MIT License – see `LICENSE`.
